================================================================================
バリアナビ（身体障害向け）スコア計算ロジック説明書
================================================================================

このドキュメントは、バリアナビアプリケーションにおける身体障害向けの
スコア計算ロジックについて説明したものです。

================================================================================
【概要】
================================================================================

身体障害者向けの駅バリアフリー度を、15項目の評価指標をもとに
0点〜15点のスコアで評価します。

各項目は「達成（1点）」または「未達成（0点）」の2値で評価され、
達成した項目の合計がその駅のスコアとなります。

表示形式：達成項目数 / 総項目数 点（例：8/15点）

================================================================================
【評価項目一覧（全15項目）】
================================================================================

■ フラグ型項目（5項目）：〇×で表せる項目
───────────────────────────────────────────────────────────────

1. 段差への対応
   - データベース値：1 = 〇（達成）、2 = ×（未達成）、3 = -（該当なし）
   - 評価基準：値が「1」であれば1点、それ以外は0点

2. 案内設備の設置の有無
   - データベース値：1 = 設置あり、2 = 設置なし、3 = 該当なし
   - 評価基準：値が「1」であれば1点、それ以外は0点

3. 障害者対応型便所の設置の有無
   - データベース値：1 = 設置あり、2 = 設置なし、3 = 該当なし
   - 評価基準：値が「1」であれば1点、それ以外は0点

4. 障害者対応型改札口の設置の有無
   - データベース値：1 = 設置あり、2 = 設置なし、3 = 該当なし
   - 評価基準：値が「1」であれば1点、それ以外は0点

5. 転落防止のための設備の設置の有無
   - データベース値：1 = 設置あり、2 = 設置なし、3 = 該当なし
   - 評価基準：値が「1」であれば1点、それ以外は0点


■ 数値型項目（10項目）：数値で表せる項目
───────────────────────────────────────────────────────────────

6. プラットホームの数
   - 基準値：6以上
   - 評価基準：6以上であれば1点、未満なら0点
   - 考え方：駅の規模に関係なく、主要なプラットホームが利用可能か

7. 段差が解消されているプラットホームの数
   - 基準値：6以上
   - 評価基準：6以上であれば1点、未満なら0点
   - 考え方：全プラットホームで段差解消が理想（プラットホーム数と同じ）

8. エレベーターの設置基数
   - 基準値：4基以上
   - 評価基準：4基以上であれば1点、未満なら0点
   - 考え方：改札口から各ホームへのアクセスを考慮（2〜4基が実用的）

9. 移動等円滑化基準に適合しているエレベーターの設置基数
   - 基準値：4基以上
   - 評価基準：4基以上であれば1点、未満なら0点
   - 考え方：エレベーター設置基数と同じ

10. エスカレーターの設置基数
    - 基準値：4基以上
    - 評価基準：4基以上であれば1点、未満なら0点
    - 考え方：エレベーターと同様（2〜4基）

11. 移動等円滑化基準に適合しているエスカレーターの設置基数
    - 基準値：4基以上
    - 評価基準：4基以上であれば1点、未満なら0点
    - 考え方：エスカレーター設置基数と同じ

12. その他の昇降機の設置基数
    - 基準値：2基以上
    - 評価基準：2基以上であれば1点、未満なら0点
    - 考え方：補助的な設備（1以上で十分か）

13. 傾斜路の設置箇所数
    - 基準値：2箇所以上
    - 評価基準：2箇所以上であれば1点、未満なら0点
    - 考え方：主要な経路（1〜2箇所）

14. 移動等円滑化基準に適合している傾斜路の設置箇所数
    - 基準値：2箇所以上
    - 評価基準：2箇所以上であれば1点、未満なら0点
    - 考え方：傾斜路設置箇所数と同じ

15. 車いす使用者の円滑な乗降が可能なプラットホームの数
    - 基準値：6以上
    - 評価基準：6以上であれば1点、未満なら0点
    - 考え方：全プラットホームが理想（プラットホーム数と同じ）


================================================================================
【スコア計算の流れ】
================================================================================

1. 各項目の評価
   ───────────────────────────────────────────────────────────────
   各項目について、以下のロジックで「達成（met = True）」か
   「未達成（met = False）」かを判定します。

   【フラグ型項目の場合】
   - データベースの値が文字列「"1"」と一致するかチェック
   - 一致すれば：met = True（1点）
   - 一致しなければ：met = False（0点）

   【数値型項目の場合】
   - データベースの値を数値に変換
   - 数値 >= 基準値（項目ごとに異なる）であれば：met = True（1点）
   - 数値 < 基準値であれば：met = False（0点）
   - 値がNULLや変換できない場合は0として扱う
   - 基準値は項目ごとに設定されており、プラットホーム関連は6、エレベーター・エスカレーター関連は4、その他は2など


2. 達成項目数のカウント
   ───────────────────────────────────────────────────────────────
   全15項目のうち、met = True となった項目の数をカウントします。

   達成項目数 = met = True の項目数


3. 総合スコアの算出
   ───────────────────────────────────────────────────────────────
   以下の値が算出されます：

   - 達成項目数（met_items）：達成した項目の数（0〜15）
   - 総項目数（total_items）：常に15
   - 達成率（percentage）：(達成項目数 / 総項目数) × 100
   - 表示ラベル（label）："{達成項目数}/{総項目数}点"


4. 表示例
   ───────────────────────────────────────────────────────────────
   例1：8項目達成した場合
   - 達成項目数：8
   - 総項目数：15
   - 達成率：53.3%
   - 表示：「8/15点」

   例2：15項目すべて達成した場合
   - 達成項目数：15
   - 総項目数：15
   - 達成率：100.0%
   - 表示：「15/15点」


================================================================================
【評価基準の考え方】
================================================================================

本アプリケーションでは、身体障害者が実際に駅を利用する上で必要な
設備の充実度を評価するため、各項目に基準値を設定しています。

■ フラグ型項目
   設備が設置されていれば（値が「1」であれば）、その項目は達成とみなします。
   設備の有無のみを評価し、設置数や品質の詳細は考慮しません。

■ 数値型項目
   各項目に設定された基準値以上であれば、その項目は達成とみなします。
   基準値は、身体障害者が実際に駅を利用する上で必要な設備の充実度を
   考慮して設定されています。

   基準値の設定根拠：
   - プラットホーム関連（6以上）：全プラットホームでの利用を想定
   - エレベーター・エスカレーター関連（4基以上）：改札口から各ホームへの
     アクセスを考慮した実用的な基準
   - その他の昇降機・傾斜路（2以上）：補助的な設備としての基準

   この基準により、身体障害者にとってより利用しやすい駅を
   適切に評価することができます。


================================================================================
【計算ロジックの実装詳細】
================================================================================

■ evaluate_metric関数（各項目の評価）
───────────────────────────────────────────────────────────────

入力：
  - value: データベースから取得した値
  - definition: 項目の定義（label, type, required）

処理：
  1. 項目タイプを確認（flag または number）
  2. フラグ型の場合：
     - 値を文字列に変換し、"1"と一致するかチェック
     - 一致すれば met = True、ratio = 1.0
     - 一致しなければ met = False、ratio = 0.0
     - 表示値は「○」または「×」
  3. 数値型の場合：
     - 値を数値に変換（変換失敗時は0.0）
     - required（基準値）と比較
     - 値 >= required なら met = True、ratio = 1.0
     - 値 < required なら met = False、ratio = 0.0
     - 表示値は実際の数値

出力：
  - raw_value: 元の値
  - required: 基準値
  - processed_value: 表示用の値（○/× または 数値）
  - ratio: 達成度（0.0 または 1.0）
  - met: 達成フラグ（True または False）


■ compute_body_score関数（総合スコア計算）
───────────────────────────────────────────────────────────────

処理：
  1. 全15項目をループ処理
  2. 各項目について evaluate_metric を実行
  3. met = True の項目数をカウント（met_items）
  4. 達成率を計算：percentage = (met_items / 15) × 100
  5. 詳細情報が必要な場合は、各項目の詳細をリストに追加

出力：
  - met_items: 達成項目数（0〜15）
  - total_items: 総項目数（常に15）
  - percentage: 達成率（0.0〜100.0）
  - details: 各項目の詳細情報（オプション）


================================================================================
【計算例】
================================================================================

■ 例1：一般的な駅の場合
───────────────────────────────────────────────────────────────

項目1（段差への対応）：値 = "1" → met = True（1点）
項目2（案内設備）：値 = "1" → met = True（1点）
項目3（障害者対応型便所）：値 = "1" → met = True（1点）
項目4（障害者対応型改札口）：値 = "2" → met = False（0点）
項目5（転落防止設備）：値 = "1" → met = True（1点）
項目6（プラットホーム数）：値 = 4 → 4 < 6 → met = False（0点）
項目7（段差解消ホーム数）：値 = 2 → 2 < 6 → met = False（0点）
項目8（エレベーター基数）：値 = 3 → 3 < 4 → met = False（0点）
項目9（適合エレベーター基数）：値 = 2 → 2 < 4 → met = False（0点）
項目10（エスカレーター基数）：値 = 0 → 0 < 4 → met = False（0点）
項目11（適合エスカレーター基数）：値 = 0 → 0 < 4 → met = False（0点）
項目12（その他の昇降機）：値 = 1 → 1 < 2 → met = False（0点）
項目13（傾斜路箇所数）：値 = 0 → 0 < 2 → met = False（0点）
項目14（適合傾斜路箇所数）：値 = 0 → 0 < 2 → met = False（0点）
項目15（車いす乗降可能ホーム数）：値 = 2 → 2 < 6 → met = False（0点）

達成項目数：5項目（フラグ型項目のみ）
総項目数：15項目
達成率：33.3%
表示：「5/15点」


■ 例2：設備が充実している駅の場合
───────────────────────────────────────────────────────────────

全15項目すべてが基準を満たしている場合：

達成項目数：15項目
総項目数：15項目
達成率：100.0%
表示：「15/15点」


■ 例3：設備が少ない駅の場合
───────────────────────────────────────────────────────────────

項目1〜5（フラグ型）：すべて値 = "2"（未設置）→ すべて0点
項目6（プラットホーム数）：値 = 2 → 2 < 6 → met = False（0点）
項目7（段差解消ホーム数）：値 = 0 → 0 < 6 → met = False（0点）
項目8（エレベーター基数）：値 = 1 → 1 < 4 → met = False（0点）
項目9〜15：すべて値 = 0 → すべて0点

達成項目数：0項目
総項目数：15項目
達成率：0.0%
表示：「0/15点」


================================================================================
【注意事項】
================================================================================

1. データベースの値について
   - フラグ型項目は文字列として「"1"」「"2"」「"3"」で保存されています
   - 数値型項目は数値として保存されています
   - NULL値や空値の場合は、0として扱われます

2. 評価基準の変更について
   - 各項目の基準値は、身体障害者が実際に駅を利用する上で必要な
     設備の充実度を考慮して設定されています
   - 基準値は項目ごとに異なり、プラットホーム関連は6、エレベーター・
     エスカレーター関連は4、その他は2などが設定されています
   - 基準値を変更する場合は、api_server.py の BODY_METRIC_DEFINITIONS を
     修正してください

3. スコアの意味について
   - スコアは「達成項目数」であり、「設備の充実度」を表します
   - スコアが高いほど、身体障害者にとって利用しやすい駅であることを
    示しますが、実際の利用可否は個々の状況によって異なります

4. 部分達成について
   - 現在のロジックでは、基準以上なら1点、未満なら0点の2値評価です
   - 部分的な達成（例：エレベーターが3基で基準値4基未満）は考慮されません
   - 基準値に達していない場合でも、実際の数値は詳細画面で確認できます

5. 詳細画面での表示について
   - 詳細画面では、各項目の「設置の有無と数」と「基準値」が並んで表示されます
   - これにより、実際の値と基準値を比較して、達成状況を確認できます
   - 数値型項目では「実際の値（基準値: X以上）」の形式で表示されます


================================================================================
【技術的な実装場所】
================================================================================

- バックエンド：api_server.py
  - BODY_METRIC_DEFINITIONS: 項目定義（54行目〜）
  - evaluate_metric関数: 各項目の評価（85行目〜）
  - compute_body_score関数: 総合スコア計算（106行目〜）

- フロントエンド：src/index.ts
  - BODY_METRICS: 項目定義（51行目〜）
  - （スコア計算はバックエンドで実行され、フロントエンドは表示のみ）


================================================================================
作成日：2025年
対象：開発者・運用者
================================================================================

