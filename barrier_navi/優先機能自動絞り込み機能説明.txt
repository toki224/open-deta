================================================================================
優先機能自動絞り込み機能の説明
================================================================================

作成日：2025年1月
バージョン：1.0

================================================================================
【1. 機能概要】
================================================================================

プロフィール画面で登録した「優先したい機能」を、各障害ページ（身体障害、聴覚障害、視覚障害）で自動的に絞り込み条件として適用する機能です。

ユーザーがプロフィールで設定した優先機能に基づいて、該当するバリアフリー設備を持つ駅のみが自動的に表示されるようになります。

================================================================================
【2. 実装の目的】
================================================================================

従来は、プロフィール画面で優先したい機能を登録できるものの、各障害ページで駅を表示する際にこの設定が反映されていませんでした。

本機能により、以下の利点が得られます：

- ユーザーが毎回手動で絞り込み条件を設定する必要がなくなる
- プロフィールで設定した優先機能が自動的に反映される
- より使いやすいユーザー体験の提供
- 個人設定に基づいたパーソナライズされた検索結果の表示

================================================================================
【3. 機能の動作フロー】
================================================================================

1. プロフィール画面での設定
   ────────────────────────────────────────────────────────────────
   ユーザーがプロフィール画面（/profile）で「優先したい機能」を選択して保存します。
   
   選択可能な機能：
   - エレベーター
   - エスカレーター
   - 障害者対応型改札口
   - 障害者対応型便所
   - 案内設備
   - 転落防止設備
   - 段差解消
   - 車いす対応プラットフォーム

2. 各障害ページでの自動適用
   ────────────────────────────────────────────────────────────────
   ユーザーが各障害ページ（/index、/hearing、/vision）を開くと：
   
   a) ログイン状態の確認
      - ログインしていない場合は機能は動作しません
      - ログインしている場合のみ、プロフィールデータを取得します
   
   b) プロフィールデータの取得
      - APIエンドポイント: GET /api/auth/profile?user_id={userId}
      - プロフィールデータから「preferred_features」を取得します
   
   c) 優先機能のマッピング
      - プロフィールで登録された優先機能名を、各障害カテゴリに対応する
        メトリックキーに変換します
      - 例：「エレベーター」→ 身体障害では「elevator_ratio」、
        視覚障害では「num_compliant_elevators」
   
   d) チェックボックスの自動チェック
      - 対応するメトリックキーのチェックボックスを自動的にチェックします
      - ユーザーが手動でチェックを外すことも可能です
   
   e) 絞り込み条件の自動適用
      - チェックされたメトリックキーを絞り込み条件として適用します
      - 該当する駅のみが表示されます
   
   f) アクティブフィルターの表示
      - 「適用中の条件」セクションに、自動適用されたフィルターが表示されます
      - ユーザーは現在適用されている条件を確認できます

================================================================================
【4. 優先機能とメトリックキーのマッピング】
================================================================================

各優先機能は、障害カテゴリごとに異なるメトリックキーにマッピングされます。

■ エレベーター
   - 身体障害: elevator_ratio（移動等円滑化基準に適合しているエレベーターの割合）
   - 聴覚障害: （該当なし）
   - 視覚障害: num_compliant_elevators（移動等円滑化基準に適合しているエレベーターの設置基数）

■ エスカレーター
   - 身体障害: escalator_ratio（移動等円滑化基準に適合しているエスカレーターの割合）
   - 聴覚障害: （該当なし）
   - 視覚障害: num_compliant_escalators（移動等円滑化基準に適合しているエスカレーターの設置基数）

■ 障害者対応型改札口
   - 身体障害: has_accessible_gate
   - 聴覚障害: has_accessible_gate
   - 視覚障害: has_accessible_gate

■ 障害者対応型便所
   - 身体障害: has_accessible_restroom
   - 聴覚障害: has_accessible_restroom
   - 視覚障害: has_accessible_restroom

■ 案内設備
   - 身体障害: has_guidance_system
   - 聴覚障害: has_guidance_system
   - 視覚障害: has_guidance_system

■ 転落防止設備
   - 身体障害: has_fall_prevention
   - 聴覚障害: has_fall_prevention
   - 視覚障害: has_fall_prevention

■ 段差解消
   - 身体障害: step_response_status（段差への対応）、platform_ratio（段差が解消されているプラットホームの割合）
   - 聴覚障害: （該当なし）
   - 視覚障害: step_response_status（段差への対応）、platform_ratio（段差が解消されているプラットホームの割合）

■ 車いす対応プラットフォーム
   - 身体障害: num_wheelchair_accessible_platforms（車いす使用者の円滑な乗降が可能なプラットホームの数）
   - 聴覚障害: （該当なし）
   - 視覚障害: （該当なし）

================================================================================
【5. 技術的な実装詳細】
================================================================================

■ 実装ファイル
───────────────────────────────────────────────────────────────

【src/index.ts】
  - PREFERRED_FEATURE_TO_METRIC_KEY: 優先機能とメトリックキーのマッピング定義
  - applyPreferredFeatures(): プロフィールデータを読み込んで優先機能を適用するメソッド
  - init(): 初期化時にapplyPreferredFeatures()を呼び出す
  - loadStations(): 既存のフィルターと優先機能をマージして適用

【src/profile.ts】
  - APIベースURLを相対パス（/api）に変更（Docker環境対応）

■ 実装のポイント
───────────────────────────────────────────────────────────────

1. ログイン状態の確認
   - localStorage.getItem('isLoggedIn')とlocalStorage.getItem('userId')で確認
   - ログインしていない場合は処理をスキップ

2. プロフィールデータの取得
   - GET /api/auth/profile?user_id={userId}でプロフィールデータを取得
   - preferred_featuresフィールドから優先機能の配列を取得

3. メトリックキーへの変換
   - PREFERRED_FEATURE_TO_METRIC_KEYマッピングを使用
   - 現在の障害カテゴリ（currentMode）に応じたメトリックキーを取得
   - 現在のモードで利用可能なメトリックのみをフィルタリング

4. チェックボックスの自動チェック
   - document.querySelector()で該当するチェックボックスを取得
   - checkedプロパティをtrueに設定

5. 絞り込み条件の適用
   - selectedFilters配列にメトリックキーを追加
   - loadStations()メソッドで既存のフィルターとマージ
   - APIリクエスト時にfiltersパラメータとして送信

6. アクティブフィルターの表示
   - updateActiveFilters()メソッドで適用中の条件を表示
   - ユーザーが手動でフィルターを削除することも可能

================================================================================
【6. 使用例】
================================================================================

■ 使用シナリオ1: 身体障害向けページでの自動絞り込み
───────────────────────────────────────────────────────────────

1. ユーザーがプロフィール画面で以下を選択：
   - エレベーター
   - 障害者対応型改札口
   - 段差解消

2. 身体障害向けページ（/index）を開く

3. 自動的に以下が適用される：
   - 「移動等円滑化基準に適合しているエレベーターの割合」のチェックボックスがチェック
   - 「障害者対応型改札口の設置の有無」のチェックボックスがチェック
   - 「段差への対応」のチェックボックスがチェック
   - 「段差が解消されているプラットホームの割合」のチェックボックスがチェック

4. これらの条件を満たす駅のみが表示される

■ 使用シナリオ2: 視覚障害向けページでの自動絞り込み
───────────────────────────────────────────────────────────────

1. ユーザーがプロフィール画面で以下を選択：
   - エレベーター
   - 案内設備

2. 視覚障害向けページ（/vision）を開く

3. 自動的に以下が適用される：
   - 「移動等円滑化基準に適合しているエレベーターの設置基数」のチェックボックスがチェック
   - 「案内設備の設置の有無」のチェックボックスがチェック

4. これらの条件を満たす駅のみが表示される

■ 使用シナリオ3: 聴覚障害向けページでの自動絞り込み
───────────────────────────────────────────────────────────────

1. ユーザーがプロフィール画面で以下を選択：
   - 障害者対応型便所
   - 案内設備
   - 転落防止設備

2. 聴覚障害向けページ（/hearing）を開く

3. 自動的に以下が適用される：
   - 「障害者対応型便所の設置の有無」のチェックボックスがチェック
   - 「案内設備の設置の有無」のチェックボックスがチェック
   - 「転落防止のための設備の設置の有無」のチェックボックスがチェック

4. これらの条件を満たす駅のみが表示される

================================================================================
【7. 注意事項】
================================================================================

■ ログインが必要
───────────────────────────────────────────────────────────────
本機能は、ユーザーがログインしている場合のみ動作します。
ゲストモードでは、プロフィールデータが取得できないため、自動絞り込みは適用されません。

■ 障害カテゴリごとの対応
───────────────────────────────────────────────────────────────
各障害カテゴリで利用可能なメトリックが異なるため、プロフィールで設定した優先機能が
すべてのカテゴリで適用されるとは限りません。

例：
- 「エレベーター」は身体障害と視覚障害では適用されますが、聴覚障害では適用されません
- 「車いす対応プラットフォーム」は身体障害でのみ適用されます

■ 手動での変更が可能
───────────────────────────────────────────────────────────────
自動的に適用されたフィルターは、ユーザーが手動でチェックを外したり、
「リセット」ボタンで解除することができます。

自動適用されたフィルターを削除すると、通常の絞り込み動作に戻ります。

■ 複数の優先機能の組み合わせ
───────────────────────────────────────────────────────────────
複数の優先機能を設定した場合、すべての条件を満たす駅のみが表示されます（AND条件）。

例：
- 「エレベーター」と「障害者対応型改札口」を設定した場合
- エレベーターがあり、かつ障害者対応型改札口がある駅のみが表示されます

================================================================================
【8. 今後の拡張可能性】
================================================================================

■ 優先度の設定
───────────────────────────────────────────────────────────────
現在はすべての優先機能が同等に扱われていますが、将来的には優先度を設定できるように
することで、より柔軟な絞り込みが可能になります。

■ OR条件のサポート
───────────────────────────────────────────────────────────────
現在はAND条件（すべての条件を満たす）のみですが、OR条件（いずれかの条件を満たす）
を選択できるようにすることで、より多くの駅が表示されるようになります。

■ 重み付けスコアリング
───────────────────────────────────────────────────────────────
優先機能に基づいてスコアに重み付けを行い、優先機能を多く満たす駅を上位に表示する
機能を追加することで、より使いやすくなります。

================================================================================
【9. トラブルシューティング】
================================================================================

■ 自動絞り込みが適用されない場合
───────────────────────────────────────────────────────────────

1. ログイン状態を確認
   - ブラウザの開発者ツールでlocalStorageを確認
   - isLoggedInが'true'、userIdが設定されているか確認

2. プロフィールデータの確認
   - プロフィール画面で優先機能が正しく保存されているか確認
   - ブラウザの開発者ツールのネットワークタブでAPIリクエストを確認

3. コンソールエラーの確認
   - ブラウザの開発者ツールのコンソールタブでエラーメッセージを確認

4. 障害カテゴリの確認
   - 選択した優先機能が、現在の障害カテゴリで利用可能か確認

■ 期待通りの駅が表示されない場合
───────────────────────────────────────────────────────────────

1. フィルター条件の確認
   - 「適用中の条件」セクションで、適用されているフィルターを確認
   - 意図しないフィルターが適用されていないか確認

2. データベースの確認
   - 該当する駅がデータベースに存在するか確認
   - 駅のバリアフリー設備データが正しく登録されているか確認

================================================================================
【10. まとめ】
================================================================================

本機能により、ユーザーがプロフィールで設定した優先機能が、各障害ページで自動的に
絞り込み条件として適用されるようになりました。

これにより、ユーザーは毎回手動で絞り込み条件を設定する必要がなくなり、より使いやすく
パーソナライズされた検索体験を得ることができます。

実装は、既存の絞り込み機能と統合されており、ユーザーが手動でフィルターを変更・削除
することも可能です。

================================================================================
作成日：2025年1月
対象：開発者・運用者・プロジェクト関係者
================================================================================

